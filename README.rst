.. image:: ./doc/001samune.png
test
=====================================================================
OCI Block Volume のアタッチメントを整理する
=====================================================================
* `詳細 <>`_

=====================================================================
デプロイ - Terraform -
=====================================================================

作業環境 - ローカル -
=====================================================================
* 64bit版 Windows 11 Pro
* Visual Studio Code 1.96.2 (Default Terminal: Git Bash)
* Git 2.47.1.windows.2
* tenv v4.1.0

フォルダ構成
=====================================================================
* `こちら <./folder.md>`_ を参照

前提条件
=====================================================================
* デプロイするコンパートメントに対し ``manage all-resources`` を付与した IAM グループに所属する IAM ユーザーが作成されていること
* 実作業は *envs* フォルダ配下の各環境フォルダで実施すること
* 以下コマンドを実行し、*DEV-ADMIN* プロファイルを作成していること (デフォルトリージョンは *ap-tokyo-1* )

.. code-block:: bash

  oci session authenticate

事前作業(1)
=====================================================================
1. 各種モジュールインストール
---------------------------------------------------------------------
* `GitHub <https://github.com/tyskJ/common-environment-setup>`_ を参照

事前作業(2)
=====================================================================
1. *tfstate* 用バケット作成
---------------------------------------------------------------------
.. code-block:: bash

  oci os bucket create \
  --compartment-id <デプロイ先コンパートメントID> \
  --name <任意のバケット名> \
  --profile DEV-ADMIN --auth security_token


実作業 - ローカル -
=====================================================================
1. *backend* 用設定ファイル作成
---------------------------------------------------------------------

.. note::

  * *envs* フォルダ配下に作成すること

.. code-block:: bash

  cat <<EOF > config.oci.tfbackend
  bucket = "作成したバケット名"
  namespace = "テナンシに一意に付与されたネームスペース"
  auth = "SecurityToken"
  config_file_profile = "DEV-ADMIN"
  region = "ap-tokyo-1"
  EOF

2. *Terraform* 初期化
---------------------------------------------------------------------
.. code-block:: bash

  terraform init -backend-config="./config.oci.tfbackend"

3. 事前確認
---------------------------------------------------------------------
.. code-block:: bash

  terraform plan

4. デプロイ
---------------------------------------------------------------------
.. code-block:: bash

  terraform apply --auto-approve

後片付け - ローカル -
=====================================================================
1. 環境削除
---------------------------------------------------------------------
.. code-block:: bash

  terraform destroy --auto-approve

2. *tfstate* 用S3バケット削除
---------------------------------------------------------------------
.. code-block:: bash

  oci os bucket delete \
  --bucket-name <作成したバケット名> \
  --force --empty \
  --profile DEV-ADMIN --auth security_token

参考資料
=====================================================================
リファレンス
---------------------------------------------------------------------
* `Backend block configuration overview <https://developer.hashicorp.com/terraform/language/backend#partial-configuration>`_
